raw_lines = <<HERE
00001 20160531 USD SEG7 -488_337.45
00001 20160531 USD SEGD +572_972.37
00001 20160531 EUR SEG7 +39_683.45
00001 20160531 GBP SEG7 -311_685.94

00002 20160531 USD SEG7 +77_364.33
00002 20160531 USD SEGD +189.19
00002 20160531 EUR SEG7 +21_396.04
00002 20160531 GBP SEG7 +1_192.71
00002 20160531 CHF SEG7 +450.00

00005 20160531 USD SEG7 +2_257.88
00005 20160531 USD SEGD +40_129.21
00005 20160531 EUR SEG7 +1_839.30
00005 20160531 GBP SEG7 +11_347.06

00019 20160531 USD SEG7 +3_878.12
00019 20160531 USD SEGD +57_086.45
00019 20160531 EUR SEG7 +517.42
00019 20160531 GBP SEG7 +67_096.02
00019 20160531 CHF SEG7 +1_940.00

00022 20160531 USD SEG7 +6_404.42
00022 20160531 USD SEGD -5_955.10
00022 20160531 EUR SEG7 +14_274.06
00022 20160531 GBP SEG7 +15_101.62

00024 20160531 USD SEG7 +5_479.79
00024 20160531 USD SEGD -132_008.74
00024 20160531 EUR SEG7 +1730.58
00024 20160531 GBP SEG7 +27_569.09

00033 20160531 USD SEG7 +5_389.90
00033 20160531 USD SEGD +7_886.22
00033 20160531 EUR SEG7 +825.72
00033 20160531 GBP SEG7 +8_482.18

00071 20160531 USD SEG7 +1_345.07
00071 20160531 USD SEGD -10_818.40
00071 20160531 EUR SEG7 +498.20
00071 20160531 GBP SEG7 +6_657.34

00077 20160531 USD SEG7 +3_328.16
00077 20160531 USD SEGD -2_430.00
00077 20160531 EUR SEG7 +805.80
00077 20160531 GBP SEG7 +5_616.64

00085 20160531 USD SEG7 +9_830.31
00085 20160531 USD SEGD +151_114.65
00085 20160531 EUR SEG7 +858.42
00085 20160531 GBP SEG7 -2_682.38

00099 20160531 USD SEG7 +8_333.05
00099 20160531 USD SEGD -24_895.45
00099 20160531 EUR SEG7 -22_361.70
00099 20160531 GBP SEG7 -11_677.94

00123 20160531 USD SEG7 +2_055.78
00123 20160531 USD SEGD -11_810.50
00123 20160531 EUR SEG7 +12_623.00
00123 20160531 GBP SEG7 +2_666.00

00201 20160531 USD SEG7 +4_615.35
00201 20160531 USD SEGD +21_507.22
00201 20160531 EUR SEG7 +1_667.20
00201 20160531 GBP SEG7 +14_220.02

00250 20160531 USD SEG7 +1_344.56
00250 20160531 USD SEGD +77_461.46
00250 20160531 EUR SEG7 +2_041.79
00250 20160531 GBP SEG7 +2_502.26

00333 20160531 USD SEG7 +16_364.55
00333 20160531 USD SEGD -8_154.20
00333 20160531 EUR SEG7 +22_754.80
00333 20160531 GBP SEG7 +2_962.64

00429 20160531 USD SEG7 +69_347.25
00429 20160531 USD SEGD +56_904.54
00429 20160531 EUR SEG7 +11_031.28
00429 20160531 GBP SEG7 +10_073.94

00451 20160531 USD SEGD -81.20
00451 20160531 EUR SEG7 -1_419.80

00455 20160531 USD SEG7 +47_619.16
00455 20160531 USD SEGD -6_115.85
00455 20160531 EUR SEG7 +3_466.60

00624 20160531 USD SEG7 +41_087.90
00624 20160531 USD SEGD +146_562.89
00624 20160531 EUR SEG7 +742.98
00624 20160531 GBP SEG7 +7_135.07

00708 20160531 USD SEG7 +76_096.71
00708 20160531 USD SEGD -11_514.20
00708 20160531 EUR SEG7 +161.00
00708 20160531 GBP SEG7 +2_693.28

00712 20160531 USD SEG7 +50_391.62
00712 20160531 USD SEGD -10_195.10
00712 20160531 EUR SEG7 +621.20
00712 20160531 GBP SEG7 -1_283.34

00789 20160531 USD SEG7 +30_685.16
00789 20160531 USD SEGD +20_924.91
00789 20160531 EUR SEG7 -1_043.82
00789 20160531 GBP SEG7 +16_390.12

00877 20160531 USD SEG7 +20_557.22
00877 20160531 USD SEGD +86_268.81
00877 20160531 EUR SEG7 +10_225.98
00877 20160531 GBP SEG7 +12_953.84

00902 20160531 USD SEG7 +7_940.43
00902 20160531 USD SEGD +590.84
00902 20160531 EUR SEG7 -8_945.72
00902 20160531 GBP SEG7 +11_237.94
00902 20160531 CHF SEG7 +450.00

01900 20160531 USD SEGD -2_978.76

01985 20160531 USD SEGD +9_849.00
01985 20160531 EUR SEG7 +2_458.44
01985 20160531 GBP SEG7 +8_651.10

02295 20160531 USD SEGD -1_041.20
02295 20160531 EUR SEG7 -670.60

03000 20160531 USD SEG7 +88_995.85
03000 20160531 USD SEGD -241_916.97
03000 20160531 EUR SEG7 -11_811.14
03000 20160531 GBP SEG7 +10_690.32

04120 20160531 USD SEG7 +14_902.49
04120 20160531 USD SEGD +81_543.43
04120 20160531 EUR SEG7 +14_505.86
04120 20160531 GBP SEG7 +2_010.14
04120 20160531 CHF SEG7 +400.00

05520 20160531 USD SEG7 +2_757.54
05520 20160531 USD SEGD +22_338.71
05520 20160531 EUR SEG7 +11_785.34
05520 20160531 GBP SEG7 +117_666.32

09009 20160531 USD SEG7 +71_704.90
09009 20160531 USD SEGD +167_970.21
09009 20160531 EUR SEG7 +13_011.98
09009 20160531 GBP SEG7 +45_678.58

39009 20160531 USD SEG7 +71_704.90
39009 20160531 USD SEGD +167_970.21
39009 20160531 EUR SEG7 +13_011.98
39009 20160531 GBP SEG7 +45_678.58

HERE

task :baseline_balances_2016_june => :environment do
  puts "Baselining balances"

  print "Deleting LedgerEntries..."
  LedgerEntry.delete_all
  puts "done"

  Rake::Task["eod:mark"].invoke('2016-05-31')

  lines = []
  raw_lines.split("\n").each do |raw_line|
    lines << raw_line
  end

  puts "Building HELD lines..."

  lines.each do |line|
    puts line

    acc_code, posted_on, ccy_code, seg_code, amount = line.split(' ')
    next if acc_code.nil?

    if Account.find_by_code(acc_code).blank?
      puts "Account #{acc_code} does not exist"
      print "Deleting LedgerEntries..."
      LedgerEntry.delete_all
      puts "done"
      puts "Exiting"
      exit
    end

    entry = LedgerEntry.create! do |e|
      e.ledger = Ledger.find_by_code('SOLE')
      e.account = Account.find_by_code(acc_code)
      e.currency = Currency.find_by_code(ccy_code)
      e.segregation = Segregation.find_by_code(seg_code)
      e.ledger_entry_type = LedgerEntryType.find_by_code('LEG')
      e.posted_on = Date.parse(posted_on)
      e.as_of_on = Date.parse(posted_on)
      e.amount = BigDecimal(amount, 8)
      e.memo = 'rebuilt'
    end

    Builders::MoneyLineBuilder.build(entry)
  end

  puts 'done'
  puts 'Build BASE MoneyLines...'

  account_ids = MoneyLine.pluck(:account_id).sort.uniq

  account_ids.each do |id|
    account = Account.find(id)
    dates = account.money_lines.pluck(:posted_on).uniq.sort
    dates.each do |date|
      account.build_base_balances(date)
    end
  end

  puts 'done'
end