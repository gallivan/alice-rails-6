<!DOCTYPE html>

<html>
<head>
<meta charset="utf-8">

<title>class Builders::ClaimBuilder - Rails Application Documentation</title>

<script type="text/javascript">
  var rdoc_rel_prefix = "../";
</script>

<script src="../js/jquery.js"></script>
<script src="../js/darkfish.js"></script>

<link href="../css/fonts.css" rel="stylesheet">
<link href="../css/rdoc.css" rel="stylesheet">



<body id="top" role="document" class="class">
<nav role="navigation">
  <div id="project-navigation">
    <div id="home-section" role="region" title="Quick navigation" class="nav-section">
  <h2>
    <a href="../index.html" rel="home">Home</a>
  </h2>

  <div id="table-of-contents-navigation">
    <a href="../table_of_contents.html#pages">Pages</a>
    <a href="../table_of_contents.html#classes">Classes</a>
    <a href="../table_of_contents.html#methods">Methods</a>
  </div>
</div>

    <div id="search-section" role="search" class="project-section initially-hidden">
  <form action="#" method="get" accept-charset="utf-8">
    <div id="search-field-wrapper">
      <input id="search-field" role="combobox" aria-label="Search"
             aria-autocomplete="list" aria-controls="search-results"
             type="text" name="search" placeholder="Search" spellcheck="false"
             title="Type to search, Up and Down to navigate, Enter to load">
    </div>

    <ul id="search-results" aria-label="Search Results"
        aria-busy="false" aria-expanded="false"
        aria-atomic="false" class="initially-hidden"></ul>
  </form>
</div>

  </div>

  

  <div id="class-metadata">
    
    <div id="parent-class-section" class="nav-section">
  <h3>Parent</h3>

  
  <p class="link"><a href="../Object.html">Object</a>
  
</div>

    
    
    <!-- Method Quickref -->
<div id="method-list-section" class="nav-section">
  <h3>Methods</h3>

  <ul class="link-list" role="directory">
    
    <li ><a href="#method-c-build_from_aacc_eod_csv">::build_from_aacc_eod_csv</a>
    
    <li ><a href="#method-c-build_from_aacc_fix_42">::build_from_aacc_fix_42</a>
    
    <li ><a href="#method-c-build_from_abn_pos_csv">::build_from_abn_pos_csv</a>
    
    <li ><a href="#method-c-build_from_ard">::build_from_ard</a>
    
    <li ><a href="#method-c-build_from_cme_eod">::build_from_cme_eod</a>
    
    <li ><a href="#method-c-build_from_cme_fixml_itd">::build_from_cme_fixml_itd</a>
    
    <li ><a href="#method-c-build_from_fix_42">::build_from_fix_42</a>
    
    <li ><a href="#method-c-cme_fixml_claim_code_mapper">::cme_fixml_claim_code_mapper</a>
    
    <li ><a href="#method-c-cme_fixml_claim_code_mapper_eod">::cme_fixml_claim_code_mapper_eod</a>
    
    <li ><a href="#method-c-find_aacc_claim_alias">::find_aacc_claim_alias</a>
    
    <li ><a href="#method-c-get_claim_set_aacc_eod_csv">::get_claim_set_aacc_eod_csv</a>
    
    <li ><a href="#method-c-get_claim_set_abn_pos_csv">::get_claim_set_abn_pos_csv</a>
    
    <li ><a href="#method-c-get_claim_set_fixml">::get_claim_set_fixml</a>
    
    <li ><a href="#method-c-get_claim_set_from_aacc_fix_42">::get_claim_set_from_aacc_fix_42</a>
    
  </ul>
</div>

  </div>
</nav>

<main role="main" aria-labelledby="class-Builders::ClaimBuilder">
  <h1 id="class-Builders::ClaimBuilder" class="class">
    class Builders::ClaimBuilder
  </h1>

  <section class="description">
    
  </section>

  
  
  
  <section id="5Buntitled-5D" class="documentation-section">
    

    

    
    <section class="constants-list">
      <header>
        <h3>Constants</h3>
      </header>
      <dl>
      
        <dt id="L2N">L2N
        
        <dd>
        
      
        <dt id="N2L">N2L
        
        <dd>
        
      
      </dl>
    </section>
    

    

    
     <section id="public-class-5Buntitled-5D-method-details" class="method-section">
       <header>
         <h3>Public Class Methods</h3>
       </header>

    
      <div id="method-c-build_from_aacc_eod_csv" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">build_from_aacc_eod_csv</span><span
            class="method-args">(params)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="build_from_aacc_eod_csv-source">
            <pre><span class="ruby-comment"># File app/models/builders/claim_builder.rb, line 58</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">build_from_aacc_eod_csv</span>(<span class="ruby-identifier">params</span>)
  <span class="ruby-identifier">system</span> = <span class="ruby-identifier">params</span>[<span class="ruby-value">:system</span>]
  <span class="ruby-identifier">dealing_venue</span> = <span class="ruby-identifier">params</span>[<span class="ruby-value">:dealing_venue</span>]

  <span class="ruby-identifier">currency_code</span> = <span class="ruby-identifier">params</span>[<span class="ruby-value">:ary</span>][<span class="ruby-value">100</span>]

  <span class="ruby-identifier">exchange_code_alias</span> = <span class="ruby-identifier">params</span>[<span class="ruby-value">:ary</span>][<span class="ruby-value">79</span>]
  <span class="ruby-identifier">claim_set_code_alias</span> = <span class="ruby-identifier">params</span>[<span class="ruby-value">:ary</span>][<span class="ruby-value">80</span>]
  <span class="ruby-identifier">maturity_code</span> = <span class="ruby-identifier">params</span>[<span class="ruby-value">:ary</span>][<span class="ruby-value">9</span>]

  <span class="ruby-identifier">claim_set</span> = <span class="ruby-identifier">get_claim_set_aacc_eod_csv</span>(<span class="ruby-identifier">params</span>)

  <span class="ruby-identifier">claim_alias_code</span> = <span class="ruby-node">&quot;#{exchange_code_alias}:#{claim_set_code_alias}:#{maturity_code}&quot;</span>
  <span class="ruby-identifier">claim_alias</span> = <span class="ruby-constant">ClaimAlias</span>.<span class="ruby-identifier">find_by_code</span>(<span class="ruby-identifier">claim_alias_code</span>)

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">claim_alias</span>
    <span class="ruby-identifier">claim_alias</span>.<span class="ruby-identifier">claim</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">currency</span> = <span class="ruby-constant">Currency</span>.<span class="ruby-identifier">find_by_code</span>(<span class="ruby-identifier">currency_code</span>) <span class="ruby-keyword">or</span> <span class="ruby-identifier">raise</span> <span class="ruby-node">&quot;Could not find Currency #{currency_code} for System #{system.code}.&quot;</span>
    <span class="ruby-identifier">claim_type</span> = <span class="ruby-constant">ClaimType</span>.<span class="ruby-identifier">find_by_code</span>(<span class="ruby-string">&#39;FUT&#39;</span>) <span class="ruby-keyword">or</span> <span class="ruby-identifier">raise</span> <span class="ruby-node">&quot;Could not find ClaimType Code FUT for System #{system.code}.&quot;</span>

    <span class="ruby-identifier">maturity_code</span> = <span class="ruby-constant">L2N</span>.<span class="ruby-identifier">invert</span>[<span class="ruby-identifier">maturity_code</span>[<span class="ruby-value">-2</span>, <span class="ruby-value">2</span>]] <span class="ruby-operator">+</span> <span class="ruby-identifier">maturity_code</span>[<span class="ruby-value">2</span>, <span class="ruby-value">2</span>]

    <span class="ruby-identifier">claim_code</span> = <span class="ruby-node">&quot;#{claim_set.code + maturity_code}&quot;</span>
    <span class="ruby-identifier">claim_name</span> = <span class="ruby-node">&quot;#{params[:ary][59]}&quot;</span>

    <span class="ruby-comment"># puts &quot;Checking for Claim #{claim_code}...&quot;</span>

    <span class="ruby-identifier">claim</span> = <span class="ruby-constant">Claim</span>.<span class="ruby-identifier">find_by_code</span>(<span class="ruby-identifier">claim_code</span>)

    <span class="ruby-keyword">if</span> <span class="ruby-identifier">claim</span>.<span class="ruby-identifier">blank?</span>
      <span class="ruby-comment"># puts &quot;Claim #{claim_code} not found. Building...&quot;</span>

      <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:ary</span>][<span class="ruby-value">11</span>] <span class="ruby-operator">==</span> <span class="ruby-string">&#39;F&#39;</span>
        <span class="ruby-comment"># puts &quot;Building Future...&quot;</span>
        <span class="ruby-identifier">claimable</span> = <span class="ruby-constant">FutureBuilder</span>.<span class="ruby-identifier">build_aacc_eod_csv</span>(<span class="ruby-identifier">params</span>, <span class="ruby-identifier">claim_code</span>)
      <span class="ruby-keyword">else</span>
        <span class="ruby-identifier">raise</span> <span class="ruby-node">&quot;Unknown ClaimType #{params[&#39;167&#39;]} from System #{system.code}. Skipping.&quot;</span>
      <span class="ruby-keyword">end</span>

      <span class="ruby-comment"># puts &quot;build claim&quot;</span>
      <span class="ruby-identifier">claim</span> = <span class="ruby-constant">Claim</span>.<span class="ruby-identifier">create</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">c</span><span class="ruby-operator">|</span>
        <span class="ruby-identifier">c</span>.<span class="ruby-identifier">code</span> = <span class="ruby-identifier">claim_code</span>
        <span class="ruby-identifier">c</span>.<span class="ruby-identifier">name</span> = <span class="ruby-identifier">claim_name</span>
        <span class="ruby-identifier">c</span>.<span class="ruby-identifier">claim_set_id</span> = <span class="ruby-identifier">claim_set</span>.<span class="ruby-identifier">id</span>
        <span class="ruby-identifier">c</span>.<span class="ruby-identifier">size</span> = <span class="ruby-constant">BigDecimal</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:ary</span>][<span class="ruby-value">68</span>])
        <span class="ruby-identifier">c</span>.<span class="ruby-identifier">point_value</span> = <span class="ruby-constant">BigDecimal</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:ary</span>][<span class="ruby-value">68</span>])
        <span class="ruby-identifier">c</span>.<span class="ruby-identifier">point_currency_id</span> = <span class="ruby-identifier">currency</span>.<span class="ruby-identifier">id</span>
        <span class="ruby-identifier">c</span>.<span class="ruby-identifier">entity_id</span> = <span class="ruby-identifier">dealing_venue</span>.<span class="ruby-identifier">entity</span>.<span class="ruby-identifier">id</span>
        <span class="ruby-identifier">c</span>.<span class="ruby-identifier">claim_type_id</span> = <span class="ruby-identifier">claim_type</span>.<span class="ruby-identifier">id</span>
        <span class="ruby-identifier">c</span>.<span class="ruby-identifier">claimable</span> = <span class="ruby-identifier">claimable</span>
      <span class="ruby-keyword">end</span>

      <span class="ruby-keyword">if</span> <span class="ruby-identifier">claim</span>.<span class="ruby-identifier">valid?</span>
        <span class="ruby-identifier">claim</span>.<span class="ruby-identifier">save!</span>
      <span class="ruby-keyword">else</span>
        <span class="ruby-identifier">claimable</span>.<span class="ruby-identifier">delete</span>
        <span class="ruby-identifier">raise</span> <span class="ruby-node">&quot;Could not build Claim: #{claim.errors}.&quot;</span>
      <span class="ruby-keyword">end</span>

      <span class="ruby-identifier">claimable</span>.<span class="ruby-identifier">update_attribute</span>(<span class="ruby-value">:claimable_id</span>, <span class="ruby-identifier">claim</span>.<span class="ruby-identifier">id</span>)
    <span class="ruby-keyword">else</span>
      <span class="ruby-comment"># puts &quot;build claim alias&quot;</span>
      <span class="ruby-keyword">begin</span>
        <span class="ruby-comment"># TODO - WHY? - PG::UniqueViolation: ERROR:  duplicate key value violates unique constraint &quot;index_claim_aliases_on_system_id_and_claim_id&quot;</span>
        <span class="ruby-constant">ClaimAlias</span>.<span class="ruby-identifier">create!</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">a</span><span class="ruby-operator">|</span>
          <span class="ruby-identifier">a</span>.<span class="ruby-identifier">system_id</span> = <span class="ruby-identifier">system</span>.<span class="ruby-identifier">id</span>
          <span class="ruby-identifier">a</span>.<span class="ruby-identifier">claim_id</span> = <span class="ruby-identifier">claim</span>.<span class="ruby-identifier">id</span>
          <span class="ruby-identifier">a</span>.<span class="ruby-identifier">code</span> = <span class="ruby-identifier">claim_alias_code</span>
        <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">rescue</span> <span class="ruby-constant">Exception</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">e</span>
        <span class="ruby-constant">Rails</span>.<span class="ruby-identifier">logger</span>.<span class="ruby-identifier">warn</span> <span class="ruby-node">&quot;ClaimAlias creation failed for #{claim_alias_code} from #{system.code}.&quot;</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-identifier">claim</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-c-build_from_aacc_fix_42" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">build_from_aacc_fix_42</span><span
            class="method-args">(params)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>&lt;FIXML&gt;</p>

<pre>&lt;TrdCaptRpt RptID=&quot;353795&quot; CopyMsgInd=&quot;Y&quot; TrdRptStat=&quot;0&quot; TrdID=&quot;4106894&quot; LastPx=&quot;314.25&quot; LastQty=&quot;1&quot; TrdDt=&quot;2016-01-28&quot; BizDt=&quot;2016-01-28&quot; TxnTm=&quot;2016-01-28T11:29:36-05:00&quot; TrdTyp=&quot;0&quot; MtchStat=&quot;0&quot; VenuTyp=&quot;E&quot; ExecID=&quot;12713436&quot; MLegRptTyp=&quot;2&quot; TrdPubInd=&quot;1&quot; RptTyp=&quot;0&quot; TransTyp=&quot;0&quot;&gt;
   &lt;Hdr Snt=&quot;2016-01-28T11:29:37-05:00&quot; SID=&quot;ICE&quot; TID=&quot;FCR&quot; /&gt;
   &lt;RegTrdID Typ=&quot;0&quot; ID=&quot;10000000000000000000000000NYZW58&quot; Src=&quot;1010000180&quot; Evnt=&quot;2&quot; /&gt;
   &lt;TrdRegTS Typ=&quot;19&quot; TS=&quot;2016-01-28T11:29:37.385-05:00&quot; /&gt;
   &lt;TrdRegTS Typ=&quot;1&quot; TS=&quot;2016-01-28T11:29:37.381-05:00&quot; /&gt;
   &lt;Pty R=&quot;73&quot; ID=&quot;IFEU&quot; /&gt;
   &lt;Instrmt ID=&quot;G&quot; SecTyp=&quot;FUT&quot; MMY=&quot;201603&quot; =&quot;IFEU&quot; SubTyp=&quot;99&quot; /&gt;
   &lt;RptSide Side=&quot;1&quot; OrdID=&quot;12713418&quot; ClOrdID2=&quot;521539299&quot; AgrsrInd=&quot;Y&quot; ClOrdID=&quot;201197609609&quot; InptSrc=&quot;ICE&quot; InptDev=&quot;ICE&quot; PosEfct=&quot;O&quot; StrategyLinkID=&quot;12713418&quot;&gt;
      &lt;Pty R=&quot;12&quot; ID=&quot;JHG&quot; /&gt;
      &lt;Pty R=&quot;21&quot; ID=&quot;ICEU&quot; /&gt;
      &lt;Pty R=&quot;4&quot; ID=&quot;FCR&quot; /&gt;
      &lt;Pty R=&quot;1&quot; ID=&quot;FCR&quot; /&gt;
      &lt;Pty R=&quot;22&quot; ID=&quot;IFEU&quot; /&gt;
      &lt;Pty R=&quot;38&quot; ID=&quot;W&quot;&gt;</pre>

<p>&lt;/FIXML&gt;</p>
          
          

          
          <div class="method-source-code" id="build_from_aacc_fix_42-source">
            <pre><span class="ruby-comment"># File app/models/builders/claim_builder.rb, line 238</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">build_from_aacc_fix_42</span>(<span class="ruby-identifier">params</span>)
  <span class="ruby-identifier">system</span> = <span class="ruby-identifier">params</span>[<span class="ruby-value">:system</span>]
  <span class="ruby-identifier">dealing_venue</span> = <span class="ruby-identifier">params</span>[<span class="ruby-value">:dealing_venue</span>]

  <span class="ruby-identifier">claim_set</span> = <span class="ruby-identifier">get_claim_set_from_aacc_fix_42</span>(<span class="ruby-identifier">params</span>)

  <span class="ruby-identifier">exchange_code</span> = <span class="ruby-identifier">params</span>[<span class="ruby-string">&#39;207&#39;</span>]
  <span class="ruby-identifier">claim_set_code_alias</span> = <span class="ruby-identifier">params</span>[<span class="ruby-string">&#39;55&#39;</span>]
  <span class="ruby-identifier">maturity_code</span> = <span class="ruby-identifier">params</span>[<span class="ruby-string">&#39;200&#39;</span>]

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-string">&#39;9039&#39;</span>] <span class="ruby-operator">=~</span> <span class="ruby-regexp">/^TRC/</span>
    <span class="ruby-identifier">currency_code</span> = <span class="ruby-identifier">params</span>[<span class="ruby-string">&#39;9039&#39;</span>].<span class="ruby-identifier">slice</span>(<span class="ruby-value">372</span>, <span class="ruby-value">3</span>)
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">currency_code</span> = <span class="ruby-string">&#39;UKN&#39;</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">claim_alias_code</span> = <span class="ruby-node">&quot;#{exchange_code}:#{claim_set_code_alias}:#{maturity_code}&quot;</span>
  <span class="ruby-comment"># claim_alias = ClaimAlias.find_by_system_id_and_code(system.id, claim_alias_code)</span>
  <span class="ruby-identifier">claim_alias</span> = <span class="ruby-constant">ClaimAlias</span>.<span class="ruby-identifier">find_by_code</span>(<span class="ruby-identifier">claim_alias_code</span>)

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">claim_alias</span>
    <span class="ruby-identifier">claim_alias</span>.<span class="ruby-identifier">claim</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">currency</span> = <span class="ruby-constant">Currency</span>.<span class="ruby-identifier">find_by_code</span>(<span class="ruby-identifier">currency_code</span>) <span class="ruby-keyword">or</span> <span class="ruby-identifier">raise</span> <span class="ruby-node">&quot;Could not find Currency #{currency_code} for System #{system.code}.&quot;</span>
    <span class="ruby-identifier">claim_type</span> = <span class="ruby-constant">ClaimType</span>.<span class="ruby-identifier">find_by_code</span>(<span class="ruby-string">&#39;FUT&#39;</span>) <span class="ruby-keyword">or</span> <span class="ruby-identifier">raise</span> <span class="ruby-node">&quot;Could not find ClaimType Code FUT for System #{system.code}.&quot;</span>

    <span class="ruby-identifier">maturity_code</span> = <span class="ruby-constant">L2N</span>.<span class="ruby-identifier">invert</span>[<span class="ruby-identifier">params</span>[<span class="ruby-string">&#39;200&#39;</span>][<span class="ruby-value">-2</span>, <span class="ruby-value">2</span>]] <span class="ruby-operator">+</span> <span class="ruby-identifier">params</span>[<span class="ruby-string">&#39;200&#39;</span>][<span class="ruby-value">2</span>, <span class="ruby-value">2</span>]

    <span class="ruby-identifier">claim_code</span> = <span class="ruby-node">&quot;#{claim_set.code + maturity_code}&quot;</span>
    <span class="ruby-identifier">claim_name</span> = <span class="ruby-node">&quot;#{claim_set.code} #{params[&#39;200&#39;]}&quot;</span>

    <span class="ruby-comment"># puts &quot;Checking for Claim #{claim_code}...&quot;</span>

    <span class="ruby-identifier">claim</span> = <span class="ruby-constant">Claim</span>.<span class="ruby-identifier">find_by_code</span>(<span class="ruby-identifier">claim_code</span>)

    <span class="ruby-keyword">if</span> <span class="ruby-identifier">claim</span>.<span class="ruby-identifier">blank?</span>
      <span class="ruby-comment"># puts &quot;Claim #{claim_code} not found. Building...&quot;</span>

      <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-string">&#39;167&#39;</span>] <span class="ruby-operator">==</span> <span class="ruby-string">&#39;FUT&#39;</span>
        <span class="ruby-comment"># puts &quot;Building Future...&quot;</span>
        <span class="ruby-identifier">claimable</span> = <span class="ruby-constant">FutureBuilder</span>.<span class="ruby-identifier">build</span>(<span class="ruby-identifier">params</span>, <span class="ruby-identifier">claim_code</span>)
      <span class="ruby-keyword">else</span>
        <span class="ruby-identifier">raise</span> <span class="ruby-node">&quot;Unknown ClaimType #{params[&#39;167&#39;]} from System #{system.code}. Skipping.&quot;</span>
      <span class="ruby-keyword">end</span>

      <span class="ruby-comment"># puts &quot;build claim&quot;</span>
      <span class="ruby-identifier">claim</span> = <span class="ruby-constant">Claim</span>.<span class="ruby-identifier">create</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">c</span><span class="ruby-operator">|</span>
        <span class="ruby-identifier">c</span>.<span class="ruby-identifier">code</span> = <span class="ruby-identifier">claim_code</span>
        <span class="ruby-identifier">c</span>.<span class="ruby-identifier">name</span> = <span class="ruby-identifier">claim_name</span>
        <span class="ruby-identifier">c</span>.<span class="ruby-identifier">claim_set_id</span> = <span class="ruby-identifier">claim_set</span>.<span class="ruby-identifier">id</span>
        <span class="ruby-identifier">c</span>.<span class="ruby-identifier">size</span> = <span class="ruby-constant">BigDecimal</span>(<span class="ruby-identifier">params</span>[<span class="ruby-string">&#39;231&#39;</span>])
        <span class="ruby-identifier">c</span>.<span class="ruby-identifier">point_value</span> = <span class="ruby-constant">BigDecimal</span>(<span class="ruby-identifier">params</span>[<span class="ruby-string">&#39;231&#39;</span>])
        <span class="ruby-identifier">c</span>.<span class="ruby-identifier">point_currency_id</span> = <span class="ruby-identifier">currency</span>.<span class="ruby-identifier">id</span>
        <span class="ruby-identifier">c</span>.<span class="ruby-identifier">entity_id</span> = <span class="ruby-identifier">dealing_venue</span>.<span class="ruby-identifier">entity</span>.<span class="ruby-identifier">id</span>
        <span class="ruby-identifier">c</span>.<span class="ruby-identifier">claim_type_id</span> = <span class="ruby-identifier">claim_type</span>.<span class="ruby-identifier">id</span>
        <span class="ruby-identifier">c</span>.<span class="ruby-identifier">claimable</span> = <span class="ruby-identifier">claimable</span>
      <span class="ruby-keyword">end</span>

      <span class="ruby-keyword">if</span> <span class="ruby-identifier">claim</span>.<span class="ruby-identifier">valid?</span>
        <span class="ruby-identifier">claim</span>.<span class="ruby-identifier">save!</span>
      <span class="ruby-keyword">else</span>
        <span class="ruby-identifier">claimable</span>.<span class="ruby-identifier">delete</span>
        <span class="ruby-identifier">raise</span> <span class="ruby-node">&quot;Could not build Claim: #{claim.errors}.&quot;</span>
      <span class="ruby-keyword">end</span>

      <span class="ruby-identifier">claimable</span>.<span class="ruby-identifier">update_attribute</span>(<span class="ruby-value">:claimable_id</span>, <span class="ruby-identifier">claim</span>.<span class="ruby-identifier">id</span>)
    <span class="ruby-keyword">else</span>
      <span class="ruby-comment"># puts &quot;build claim alias&quot;</span>
      <span class="ruby-keyword">begin</span>
        <span class="ruby-comment"># TODO - WHY? - PG::UniqueViolation: ERROR:  duplicate key value violates unique constraint &quot;index_claim_aliases_on_system_id_and_claim_id&quot;</span>
        <span class="ruby-constant">ClaimAlias</span>.<span class="ruby-identifier">create!</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">a</span><span class="ruby-operator">|</span>
          <span class="ruby-identifier">a</span>.<span class="ruby-identifier">system_id</span> = <span class="ruby-identifier">system</span>.<span class="ruby-identifier">id</span>
          <span class="ruby-identifier">a</span>.<span class="ruby-identifier">claim_id</span> = <span class="ruby-identifier">claim</span>.<span class="ruby-identifier">id</span>
          <span class="ruby-identifier">a</span>.<span class="ruby-identifier">code</span> = <span class="ruby-identifier">claim_alias_code</span>
        <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">rescue</span> <span class="ruby-constant">Exception</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">e</span>
        <span class="ruby-constant">Rails</span>.<span class="ruby-identifier">logger</span>.<span class="ruby-identifier">warn</span> <span class="ruby-node">&quot;ClaimAlias creation failed for #{claim_alias_code} from #{system.code}.&quot;</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-identifier">claim</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-c-build_from_abn_pos_csv" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">build_from_abn_pos_csv</span><span
            class="method-args">(params)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="build_from_abn_pos_csv-source">
            <pre><span class="ruby-comment"># File app/models/builders/claim_builder.rb, line 136</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">build_from_abn_pos_csv</span>(<span class="ruby-identifier">params</span>)
  <span class="ruby-identifier">system</span> = <span class="ruby-identifier">params</span>[<span class="ruby-value">:system</span>]
  <span class="ruby-identifier">dealing_venue</span> = <span class="ruby-identifier">params</span>[<span class="ruby-value">:dealing_venue</span>]

  <span class="ruby-identifier">ary</span> = <span class="ruby-identifier">params</span>[<span class="ruby-value">:ary</span>]


  <span class="ruby-identifier">currency_code</span> = <span class="ruby-identifier">ary</span>[<span class="ruby-value">32</span>]

  <span class="ruby-identifier">exchange_code_alias</span> = <span class="ruby-identifier">ary</span>[<span class="ruby-value">11</span>]
  <span class="ruby-identifier">claim_set_code_alias</span> = <span class="ruby-identifier">ary</span>[<span class="ruby-value">12</span>]
  <span class="ruby-identifier">maturity_code</span> = <span class="ruby-identifier">ary</span>[<span class="ruby-value">16</span>]

  <span class="ruby-identifier">claim_set</span> = <span class="ruby-identifier">get_claim_set_abn_pos_csv</span>(<span class="ruby-identifier">params</span>)

  <span class="ruby-identifier">claim_alias_code</span> = <span class="ruby-node">&quot;#{exchange_code_alias}:#{claim_set_code_alias}:#{maturity_code}&quot;</span>
  <span class="ruby-identifier">claim_alias</span> = <span class="ruby-constant">ClaimAlias</span>.<span class="ruby-identifier">find_by_code</span>(<span class="ruby-identifier">claim_alias_code</span>)

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">claim_alias</span>
    <span class="ruby-identifier">claim_alias</span>.<span class="ruby-identifier">claim</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">currency</span> = <span class="ruby-constant">Currency</span>.<span class="ruby-identifier">find_by_code</span>(<span class="ruby-identifier">currency_code</span>) <span class="ruby-keyword">or</span> <span class="ruby-identifier">raise</span> <span class="ruby-node">&quot;Could not find Currency #{currency_code} for System #{system.code}.&quot;</span>
    <span class="ruby-identifier">claim_type</span> = <span class="ruby-constant">ClaimType</span>.<span class="ruby-identifier">find_by_code</span>(<span class="ruby-string">&#39;FUT&#39;</span>) <span class="ruby-keyword">or</span> <span class="ruby-identifier">raise</span> <span class="ruby-node">&quot;Could not find ClaimType Code FUT for System #{system.code}.&quot;</span>

    <span class="ruby-identifier">maturity_code</span> = <span class="ruby-constant">L2N</span>.<span class="ruby-identifier">invert</span>[<span class="ruby-identifier">maturity_code</span>[<span class="ruby-value">-2</span>, <span class="ruby-value">2</span>]] <span class="ruby-operator">+</span> <span class="ruby-identifier">maturity_code</span>[<span class="ruby-value">2</span>, <span class="ruby-value">2</span>]

    <span class="ruby-identifier">claim_code</span> = <span class="ruby-node">&quot;#{claim_set.code + maturity_code}&quot;</span>
    <span class="ruby-identifier">claim_name</span> = <span class="ruby-node">&quot;#{ary[218]}&quot;</span>

    <span class="ruby-comment"># puts &quot;Checking for Claim #{claim_code}...&quot;</span>

    <span class="ruby-identifier">claim</span> = <span class="ruby-constant">Claim</span>.<span class="ruby-identifier">find_by_code</span>(<span class="ruby-identifier">claim_code</span>)

    <span class="ruby-keyword">if</span> <span class="ruby-identifier">claim</span>.<span class="ruby-identifier">blank?</span>
      <span class="ruby-comment"># puts &quot;Claim #{claim_code} not found. Building...&quot;</span>

      <span class="ruby-keyword">if</span> <span class="ruby-identifier">ary</span>[<span class="ruby-value">15</span>] <span class="ruby-operator">==</span> <span class="ruby-string">&#39;F&#39;</span>
        <span class="ruby-comment"># puts &quot;Building Future...&quot;</span>
        <span class="ruby-identifier">claimable</span> = <span class="ruby-constant">FutureBuilder</span>.<span class="ruby-identifier">build_aacc_eod_csv</span>(<span class="ruby-identifier">params</span>, <span class="ruby-identifier">claim_code</span>)
      <span class="ruby-keyword">else</span>
        <span class="ruby-identifier">raise</span> <span class="ruby-node">&quot;Unknown ClaimType #{params[15]} from System #{system.code}. Skipping.&quot;</span>
      <span class="ruby-keyword">end</span>

      <span class="ruby-identifier">puts</span> <span class="ruby-string">&#39;*&#39;</span> <span class="ruby-operator">*</span> <span class="ruby-value">20</span>
      <span class="ruby-identifier">puts</span> <span class="ruby-identifier">claim_code</span>
      <span class="ruby-identifier">puts</span> <span class="ruby-identifier">claim_name</span>

      <span class="ruby-comment"># puts &quot;build claim&quot;</span>
      <span class="ruby-identifier">claim</span> = <span class="ruby-constant">Claim</span>.<span class="ruby-identifier">create</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">c</span><span class="ruby-operator">|</span>
        <span class="ruby-identifier">c</span>.<span class="ruby-identifier">code</span> = <span class="ruby-identifier">claim_code</span>
        <span class="ruby-identifier">c</span>.<span class="ruby-identifier">name</span> = <span class="ruby-identifier">claim_name</span>
        <span class="ruby-identifier">c</span>.<span class="ruby-identifier">claim_set_id</span> = <span class="ruby-identifier">claim_set</span>.<span class="ruby-identifier">id</span>
        <span class="ruby-identifier">c</span>.<span class="ruby-identifier">size</span> = <span class="ruby-constant">BigDecimal</span>(<span class="ruby-identifier">ary</span>[<span class="ruby-value">68</span>])
        <span class="ruby-identifier">c</span>.<span class="ruby-identifier">point_value</span> = <span class="ruby-constant">BigDecimal</span>(<span class="ruby-identifier">ary</span>[<span class="ruby-value">68</span>])
        <span class="ruby-identifier">c</span>.<span class="ruby-identifier">point_currency_id</span> = <span class="ruby-identifier">currency</span>.<span class="ruby-identifier">id</span>
        <span class="ruby-identifier">c</span>.<span class="ruby-identifier">entity_id</span> = <span class="ruby-identifier">dealing_venue</span>.<span class="ruby-identifier">entity</span>.<span class="ruby-identifier">id</span>
        <span class="ruby-identifier">c</span>.<span class="ruby-identifier">claim_type_id</span> = <span class="ruby-identifier">claim_type</span>.<span class="ruby-identifier">id</span>
        <span class="ruby-identifier">c</span>.<span class="ruby-identifier">claimable</span> = <span class="ruby-identifier">claimable</span>
      <span class="ruby-keyword">end</span>

      <span class="ruby-keyword">if</span> <span class="ruby-identifier">claim</span>.<span class="ruby-identifier">valid?</span>
        <span class="ruby-identifier">claim</span>.<span class="ruby-identifier">save!</span>
      <span class="ruby-keyword">else</span>
        <span class="ruby-identifier">claimable</span>.<span class="ruby-identifier">delete</span>
        <span class="ruby-identifier">raise</span> <span class="ruby-node">&quot;Could not build Claim: #{claim.errors}.&quot;</span>
      <span class="ruby-keyword">end</span>

      <span class="ruby-identifier">claimable</span>.<span class="ruby-identifier">update_attribute</span>(<span class="ruby-value">:claimable_id</span>, <span class="ruby-identifier">claim</span>.<span class="ruby-identifier">id</span>)
    <span class="ruby-keyword">else</span>
      <span class="ruby-comment"># puts &quot;build claim alias&quot;</span>
      <span class="ruby-keyword">begin</span>
        <span class="ruby-comment"># TODO - WHY? - PG::UniqueViolation: ERROR:  duplicate key value violates unique constraint &quot;index_claim_aliases_on_system_id_and_claim_id&quot;</span>
        <span class="ruby-constant">ClaimAlias</span>.<span class="ruby-identifier">create!</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">a</span><span class="ruby-operator">|</span>
          <span class="ruby-identifier">a</span>.<span class="ruby-identifier">system_id</span> = <span class="ruby-identifier">system</span>.<span class="ruby-identifier">id</span>
          <span class="ruby-identifier">a</span>.<span class="ruby-identifier">claim_id</span> = <span class="ruby-identifier">claim</span>.<span class="ruby-identifier">id</span>
          <span class="ruby-identifier">a</span>.<span class="ruby-identifier">code</span> = <span class="ruby-identifier">claim_alias_code</span>
        <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">rescue</span> <span class="ruby-constant">Exception</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">e</span>
        <span class="ruby-constant">Rails</span>.<span class="ruby-identifier">logger</span>.<span class="ruby-identifier">warn</span> <span class="ruby-node">&quot;ClaimAlias creation failed for #{claim_alias_code} from #{system.code}.&quot;</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-identifier">claim</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-c-build_from_ard" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">build_from_ard</span><span
            class="method-args">(line)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="build_from_ard-source">
            <pre><span class="ruby-comment"># File app/models/builders/claim_builder.rb, line 22</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">build_from_ard</span>(<span class="ruby-identifier">line</span>)
  <span class="ruby-comment">#* CBT    06         201703                                                   SOYBEAN MEAL FUTURES                               SETTLEMENT PRICE:         332.80      USD *</span>
   <span class="ruby-identifier">line</span> = <span class="ruby-identifier">line</span>.<span class="ruby-identifier">gsub</span>(<span class="ruby-regexp">/\s+/</span>, <span class="ruby-string">&#39; &#39;</span>).<span class="ruby-identifier">gsub</span>(<span class="ruby-string">&#39;* &#39;</span>,<span class="ruby-string">&#39;&#39;</span>).<span class="ruby-identifier">gsub</span>(<span class="ruby-string">&#39; *&#39;</span>, <span class="ruby-string">&#39;&#39;</span>)
   <span class="ruby-comment"># puts line</span>
   <span class="ruby-identifier">ary</span> = <span class="ruby-identifier">line</span>.<span class="ruby-identifier">split</span>(<span class="ruby-regexp">/ /</span>)
   <span class="ruby-identifier">maturity_code</span> = <span class="ruby-identifier">ary</span>[<span class="ruby-value">2</span>]
   <span class="ruby-identifier">maturity_code</span> = <span class="ruby-constant">N2L</span>[<span class="ruby-identifier">maturity_code</span>[<span class="ruby-value">-2</span>, <span class="ruby-value">2</span>]] <span class="ruby-operator">+</span> <span class="ruby-identifier">maturity_code</span>[<span class="ruby-value">2</span>, <span class="ruby-value">2</span>]
   <span class="ruby-identifier">code</span> = <span class="ruby-identifier">ary</span>[<span class="ruby-value">0</span>] <span class="ruby-operator">+</span> <span class="ruby-string">&#39;:&#39;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">ary</span>[<span class="ruby-value">1</span>] <span class="ruby-operator">+</span> <span class="ruby-identifier">maturity_code</span>
   <span class="ruby-identifier">claim</span> = <span class="ruby-constant">Claim</span>.<span class="ruby-identifier">find_by_code</span>(<span class="ruby-identifier">code</span>)
   <span class="ruby-comment"># if claim.blank?</span>
   <span class="ruby-comment">#   puts &quot;Claim #{code} not found&quot;</span>
   <span class="ruby-comment"># else</span>
   <span class="ruby-comment">#   puts &quot;Claim #{code} found&quot;</span>
   <span class="ruby-comment"># end</span>
  <span class="ruby-identifier">claim</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-c-build_from_cme_eod" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">build_from_cme_eod</span><span
            class="method-args">(params)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>{“FIXML”=&gt;</p>

<pre>{&quot;TrdCaptRpt&quot;=&gt;
  {&quot;RptID&quot;=&gt;&quot;21937832663&quot;,
   &quot;TrdTyp&quot;=&gt;&quot;0&quot;,
   &quot;TrdSubTyp&quot;=&gt;&quot;7&quot;,
   &quot;ExecID&quot;=&gt;&quot;87472920160720190002TN0000015&quot;,
   &quot;TrdDt&quot;=&gt;&quot;2016-07-21&quot;,
   &quot;BizDt&quot;=&gt;&quot;2016-07-21&quot;,
   &quot;MLegRptTyp&quot;=&gt;&quot;2&quot;,
   &quot;MtchStat&quot;=&gt;&quot;0&quot;,
   &quot;MsgEvtSrc&quot;=&gt;&quot;REG&quot;,
   &quot;TrdID&quot;=&gt;&quot;100432&quot;,
   &quot;LastQty&quot;=&gt;&quot;1&quot;,
   &quot;LastPx&quot;=&gt;&quot;347.7&quot;,
   &quot;TxnTm&quot;=&gt;&quot;2016-07-20T19:00:02-05:00&quot;,
   &quot;SettlCcy&quot;=&gt;&quot;USD&quot;,
   &quot;SettlDt&quot;=&gt;&quot;2016-12-14&quot;,
   &quot;OrigTrdID&quot;=&gt;&quot;155FADF8568LTP0202D90652A&quot;,
   &quot;PxSubTyp&quot;=&gt;&quot;1&quot;,
   &quot;VenueTyp&quot;=&gt;&quot;E&quot;,
   &quot;VenuTyp&quot;=&gt;&quot;E&quot;,
   &quot;Instrmt&quot;=&gt;
    {&quot;ID&quot;=&gt;&quot;06&quot;,
     &quot;Desc&quot;=&gt;&quot;SOYBEAN MEAL FUTURES&quot;,
     &quot;CFI&quot;=&gt;&quot;FCAPSO&quot;,
     &quot;SecTyp&quot;=&gt;&quot;FUT&quot;,
     &quot;MMY&quot;=&gt;&quot;201612&quot;,
     &quot;MatDt&quot;=&gt;&quot;2016-12-14&quot;,
     &quot;Mult&quot;=&gt;&quot;100&quot;,
     &quot;Exch&quot;=&gt;&quot;CBT&quot;,
     &quot;UOM&quot;=&gt;&quot;tn&quot;,
     &quot;UOMQty&quot;=&gt;&quot;100&quot;,
     &quot;PxUOM&quot;=&gt;&quot;TON&quot;,
     &quot;PxUOMQty&quot;=&gt;&quot;1&quot;,
     &quot;ValMeth&quot;=&gt;&quot;FUT&quot;,
     &quot;Fctr&quot;=&gt;&quot;1&quot;,
     &quot;PxQteCcy&quot;=&gt;&quot;USD&quot;},
   &quot;Amt&quot;=&gt;{&quot;Typ&quot;=&gt;&quot;TVAR&quot;, &quot;Amt&quot;=&gt;&quot;20&quot;, &quot;Ccy&quot;=&gt;&quot;USD&quot;},
   &quot;RptSide&quot;=&gt;
    {&quot;Side&quot;=&gt;&quot;2&quot;,
     &quot;ClOrdID&quot;=&gt;&quot;17W9&quot;,
     &quot;CustCpcty&quot;=&gt;&quot;2&quot;,
     &quot;OrdTyp&quot;=&gt;&quot;L&quot;,
     &quot;SesID&quot;=&gt;&quot;EOD&quot;,
     &quot;SesSub&quot;=&gt;&quot;E&quot;,
     &quot;AllocInd&quot;=&gt;&quot;0&quot;,
     &quot;AgrsrInd&quot;=&gt;&quot;Y&quot;,
     &quot;Pty&quot;=&gt;
      [{&quot;ID&quot;=&gt;&quot;CME&quot;, &quot;R&quot;=&gt;&quot;21&quot;},
       {&quot;ID&quot;=&gt;&quot;353&quot;, &quot;R&quot;=&gt;&quot;4&quot;},
       {&quot;ID&quot;=&gt;&quot;CBT&quot;, &quot;R&quot;=&gt;&quot;22&quot;},
       {&quot;ID&quot;=&gt;&quot;330&quot;, &quot;R&quot;=&gt;&quot;1&quot;},
       {&quot;ID&quot;=&gt;&quot;00333&quot;, &quot;R&quot;=&gt;&quot;24&quot;, &quot;Sub&quot;=&gt;{&quot;ID&quot;=&gt;&quot;2&quot;, &quot;Typ&quot;=&gt;&quot;26&quot;}},
       {&quot;ID&quot;=&gt;&quot;3E3L&quot;, &quot;R&quot;=&gt;&quot;12&quot;},
       {&quot;ID&quot;=&gt;&quot;330B&quot;, &quot;R&quot;=&gt;&quot;38&quot;, &quot;Sub&quot;=&gt;{&quot;ID&quot;=&gt;&quot;2&quot;, &quot;Typ&quot;=&gt;&quot;26&quot;}},
       {&quot;ID&quot;=&gt;&quot;330&quot;, &quot;R&quot;=&gt;&quot;7&quot;}],
     &quot;RegTrdID&quot;=&gt;
      {&quot;ID&quot;=&gt;&quot;FECF155FADF8568LTP0202D90652E&quot;,
       &quot;Src&quot;=&gt;&quot;1010000023&quot;,
       &quot;Typ&quot;=&gt;&quot;0&quot;,
       &quot;Evnt&quot;=&gt;&quot;2&quot;}}}}}</pre>
          
          

          
          <div class="method-source-code" id="build_from_cme_eod-source">
            <pre><span class="ruby-comment"># File app/models/builders/claim_builder.rb, line 606</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">build_from_cme_eod</span>(<span class="ruby-identifier">params</span>)
  <span class="ruby-identifier">system</span> = <span class="ruby-constant">System</span>.<span class="ruby-identifier">find_by_code</span>(<span class="ruby-string">&#39;CMEsys&#39;</span>)

  <span class="ruby-identifier">size</span> = <span class="ruby-constant">BigDecimal</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">params</span>[<span class="ruby-string">&#39;FIXML&#39;</span>][<span class="ruby-string">&#39;TrdCaptRpt&#39;</span>][<span class="ruby-string">&#39;Instrmt&#39;</span>][<span class="ruby-string">&#39;UOMQty&#39;</span>], <span class="ruby-value">8</span>)
  <span class="ruby-identifier">point_value</span> = <span class="ruby-constant">BigDecimal</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">params</span>[<span class="ruby-string">&#39;FIXML&#39;</span>][<span class="ruby-string">&#39;TrdCaptRpt&#39;</span>][<span class="ruby-string">&#39;Instrmt&#39;</span>][<span class="ruby-string">&#39;Mult&#39;</span>], <span class="ruby-value">8</span>)

  <span class="ruby-identifier">entity_code</span> = <span class="ruby-identifier">params</span>[<span class="ruby-string">&#39;FIXML&#39;</span>][<span class="ruby-string">&#39;TrdCaptRpt&#39;</span>][<span class="ruby-string">&#39;Instrmt&#39;</span>][<span class="ruby-string">&#39;Exch&#39;</span>]
  <span class="ruby-identifier">entity_alias</span> = <span class="ruby-constant">EntityAlias</span>.<span class="ruby-identifier">find_by_system_id_and_code</span>(<span class="ruby-identifier">system</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">entity_code</span>)
  <span class="ruby-identifier">entity</span> = <span class="ruby-identifier">entity_alias</span>.<span class="ruby-identifier">entity</span>

  <span class="ruby-identifier">clearing_code</span> = <span class="ruby-identifier">params</span>[<span class="ruby-string">&#39;FIXML&#39;</span>][<span class="ruby-string">&#39;TrdCaptRpt&#39;</span>][<span class="ruby-string">&#39;Instrmt&#39;</span>][<span class="ruby-string">&#39;ID&#39;</span>]
  <span class="ruby-identifier">clearing_desc</span> = <span class="ruby-identifier">params</span>[<span class="ruby-string">&#39;FIXML&#39;</span>][<span class="ruby-string">&#39;TrdCaptRpt&#39;</span>][<span class="ruby-string">&#39;Instrmt&#39;</span>][<span class="ruby-string">&#39;Desc&#39;</span>]

  <span class="ruby-identifier">claim_code</span> = <span class="ruby-identifier">cme_fixml_claim_code_mapper_eod</span>(<span class="ruby-identifier">params</span>)
  <span class="ruby-identifier">claim_type_code</span> = <span class="ruby-identifier">params</span>[<span class="ruby-string">&#39;FIXML&#39;</span>][<span class="ruby-string">&#39;TrdCaptRpt&#39;</span>][<span class="ruby-string">&#39;Instrmt&#39;</span>][<span class="ruby-string">&#39;SecTyp&#39;</span>]
  <span class="ruby-identifier">claim_type</span> = <span class="ruby-constant">ClaimType</span>.<span class="ruby-identifier">find_by_code</span>(<span class="ruby-identifier">claim_type_code</span>)
  <span class="ruby-identifier">claim_sub_type_code</span> = <span class="ruby-identifier">params</span>[<span class="ruby-string">&#39;FIXML&#39;</span>][<span class="ruby-string">&#39;TrdCaptRpt&#39;</span>][<span class="ruby-string">&#39;Instrmt&#39;</span>][<span class="ruby-string">&#39;SubTyp&#39;</span>]
  <span class="ruby-identifier">claim_sub_type</span> = <span class="ruby-constant">ClaimSubType</span>.<span class="ruby-identifier">find_by_code</span>(<span class="ruby-identifier">claim_sub_type_code</span>)

  <span class="ruby-identifier">currency_code</span> = <span class="ruby-identifier">params</span>[<span class="ruby-string">&#39;FIXML&#39;</span>][<span class="ruby-string">&#39;TrdCaptRpt&#39;</span>][<span class="ruby-string">&#39;Instrmt&#39;</span>][<span class="ruby-string">&#39;PxQteCcy&#39;</span>]

  <span class="ruby-identifier">claim_set_code</span> = <span class="ruby-node">&quot;#{entity_code}:#{clearing_code}&quot;</span>

  <span class="ruby-identifier">claim_set</span> = <span class="ruby-constant">ClaimSet</span>.<span class="ruby-identifier">find_by_code</span>(<span class="ruby-identifier">claim_set_code</span>)

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">claim_set</span>.<span class="ruby-identifier">blank?</span>
    <span class="ruby-identifier">claim_set</span> = <span class="ruby-constant">ClaimSet</span>.<span class="ruby-identifier">create!</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">cs</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">cs</span>.<span class="ruby-identifier">code</span> = <span class="ruby-identifier">claim_set_code</span>
      <span class="ruby-identifier">cs</span>.<span class="ruby-identifier">name</span> = <span class="ruby-node">&quot;#{entity_code}:#{clearing_desc}&quot;</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">claim_code</span> = <span class="ruby-node">&quot;#{entity_code}:#{claim_code}&quot;</span>

  <span class="ruby-identifier">claim</span> = <span class="ruby-constant">Claim</span>.<span class="ruby-identifier">find_by_code</span>(<span class="ruby-identifier">claim_code</span>)

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">claim</span>.<span class="ruby-identifier">blank?</span>
    <span class="ruby-comment"># puts &quot;building claimable #{claim_code}&quot;</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">claim_type_code</span> <span class="ruby-operator">==</span> <span class="ruby-string">&#39;FUT&#39;</span>
      <span class="ruby-comment"># puts &quot;Building Future...&quot;</span>
      <span class="ruby-identifier">claimable</span> = <span class="ruby-constant">FutureBuilder</span>.<span class="ruby-identifier">build_cme_eod</span>(<span class="ruby-identifier">params</span>, <span class="ruby-identifier">claim_code</span>)
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">raise</span> <span class="ruby-node">&quot;Unknown ClaimType #{claim_type_code} from System #{system.code}. Skipping.&quot;</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-identifier">point_value</span> = <span class="ruby-identifier">point_value</span><span class="ruby-operator">/</span><span class="ruby-value">100</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">entity_code</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp">/CBT/</span> <span class="ruby-keyword">and</span> <span class="ruby-identifier">clearing_code</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp">/S|C|W|KW/</span>

    <span class="ruby-comment"># puts &quot;building claim #{claim_code}&quot;</span>
    <span class="ruby-identifier">claim</span> = <span class="ruby-constant">Claim</span>.<span class="ruby-identifier">create!</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">c</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">c</span>.<span class="ruby-identifier">claimable</span> = <span class="ruby-identifier">claimable</span>
      <span class="ruby-identifier">c</span>.<span class="ruby-identifier">claimable_type</span> = <span class="ruby-string">&#39;Future&#39;</span>
      <span class="ruby-identifier">c</span>.<span class="ruby-identifier">claim_set</span> = <span class="ruby-identifier">claim_set</span>
      <span class="ruby-identifier">c</span>.<span class="ruby-identifier">entity_id</span> = <span class="ruby-identifier">entity</span>.<span class="ruby-identifier">id</span>
      <span class="ruby-identifier">c</span>.<span class="ruby-identifier">code</span> = <span class="ruby-identifier">claim_code</span>
      <span class="ruby-identifier">c</span>.<span class="ruby-identifier">name</span> = <span class="ruby-identifier">claim_code</span>
      <span class="ruby-identifier">c</span>.<span class="ruby-identifier">size</span> = <span class="ruby-identifier">size</span>
      <span class="ruby-identifier">c</span>.<span class="ruby-identifier">claim_type</span> = <span class="ruby-identifier">claim_type</span>
      <span class="ruby-identifier">c</span>.<span class="ruby-identifier">claim_sub_type</span> = <span class="ruby-identifier">claim_sub_type</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">claim_sub_type</span>.<span class="ruby-identifier">blank?</span>
      <span class="ruby-identifier">c</span>.<span class="ruby-identifier">point_value</span> = <span class="ruby-identifier">point_value</span>
      <span class="ruby-identifier">c</span>.<span class="ruby-identifier">point_currency_id</span> = <span class="ruby-constant">Currency</span>.<span class="ruby-identifier">find_by_code</span>(<span class="ruby-identifier">currency_code</span>).<span class="ruby-identifier">id</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-identifier">claimable</span>.<span class="ruby-identifier">update_attribute</span>(<span class="ruby-value">:claimable_id</span>, <span class="ruby-identifier">claim</span>.<span class="ruby-identifier">id</span>)
  <span class="ruby-keyword">else</span>
    <span class="ruby-comment"># puts &quot;found claim #{claim_code}&quot;</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-comment"># puts &#39;*&#39; * 100</span>
  <span class="ruby-comment"># puts claim.valid?</span>
  <span class="ruby-comment"># puts claim.errors.keys</span>
  <span class="ruby-comment"># puts claim.entity.code</span>

  <span class="ruby-identifier">claim</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-c-build_from_cme_fixml_itd" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">build_from_cme_fixml_itd</span><span
            class="method-args">(fixml)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="build_from_cme_fixml_itd-source">
            <pre><span class="ruby-comment"># File app/models/builders/claim_builder.rb, line 474</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">build_from_cme_fixml_itd</span>(<span class="ruby-identifier">fixml</span>)
  <span class="ruby-identifier">doc</span> = <span class="ruby-constant">Nokogiri</span><span class="ruby-operator">::</span><span class="ruby-constant">XML</span>(<span class="ruby-identifier">fixml</span>)
  <span class="ruby-identifier">claim_code</span> = <span class="ruby-identifier">cme_fixml_claim_code_mapper</span>(<span class="ruby-identifier">doc</span>)
  <span class="ruby-identifier">clearing_code</span> = <span class="ruby-identifier">doc</span>.<span class="ruby-identifier">css</span>(<span class="ruby-string">&#39;FIXML TrdCaptRpt Instrmt&#39;</span>).<span class="ruby-identifier">first</span>[<span class="ruby-string">&#39;ID&#39;</span>] <span class="ruby-comment"># ED, C</span>
  <span class="ruby-identifier">system</span> = <span class="ruby-constant">System</span>.<span class="ruby-identifier">find_by_code</span>(<span class="ruby-string">&#39;CME_FIX_ITD&#39;</span>)
  <span class="ruby-identifier">entity_code</span> = <span class="ruby-identifier">doc</span>.<span class="ruby-identifier">css</span>(<span class="ruby-string">&#39;FIXML TrdCaptRpt Instrmt&#39;</span>).<span class="ruby-identifier">first</span>[<span class="ruby-string">&#39;Exch&#39;</span>]
  <span class="ruby-identifier">entity</span> = <span class="ruby-constant">EntityAlias</span>.<span class="ruby-identifier">find_by_system_id_and_code</span>(<span class="ruby-identifier">system</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">entity_code</span>)
  <span class="ruby-identifier">size</span> = <span class="ruby-identifier">doc</span>.<span class="ruby-identifier">css</span>(<span class="ruby-string">&#39;FIXML TrdCaptRpt Instrmt&#39;</span>).<span class="ruby-identifier">first</span>[<span class="ruby-string">&#39;UOMQty&#39;</span>]
  <span class="ruby-identifier">size_price_divisor</span> = <span class="ruby-identifier">doc</span>.<span class="ruby-identifier">css</span>(<span class="ruby-string">&#39;FIXML TrdCaptRpt Instrmt&#39;</span>).<span class="ruby-identifier">first</span>[<span class="ruby-string">&#39;PxUOMQty&#39;</span>]
  <span class="ruby-identifier">point_value</span> = <span class="ruby-constant">BigDecimal</span>(<span class="ruby-identifier">size</span> <span class="ruby-operator">/</span> <span class="ruby-identifier">size_price_divisor</span>, <span class="ruby-value">8</span>)
  <span class="ruby-identifier">claim_type_code</span> = <span class="ruby-identifier">doc</span>.<span class="ruby-identifier">css</span>(<span class="ruby-string">&#39;FIXML TrdCaptRpt Instrmt&#39;</span>).<span class="ruby-identifier">first</span>[<span class="ruby-string">&#39;SecTyp&#39;</span>]
  <span class="ruby-identifier">claim_type</span> = <span class="ruby-constant">ClaimType</span>.<span class="ruby-identifier">find_by_code</span>(<span class="ruby-identifier">claim_type_code</span>)
  <span class="ruby-identifier">claim_sub_type_code</span> = <span class="ruby-identifier">doc</span>.<span class="ruby-identifier">css</span>(<span class="ruby-string">&#39;FIXML TrdCaptRpt Instrmt&#39;</span>).<span class="ruby-identifier">first</span>[<span class="ruby-string">&#39;SubTyp&#39;</span>]
  <span class="ruby-identifier">claim_sub_type</span> = <span class="ruby-constant">ClaimSubType</span>.<span class="ruby-identifier">find_by_code</span>(<span class="ruby-identifier">claim_sub_type_code</span>)
  <span class="ruby-comment"># claim_multiplier = BigDecimal.new(doc.css(&#39;FIXML TrdCaptRpt Instrmt&#39;).first[&#39;Mult&#39;])</span>

  <span class="ruby-identifier">claim_set</span> = <span class="ruby-constant">ClaimSet</span>.<span class="ruby-identifier">find_by_code</span>(<span class="ruby-identifier">clearing_code</span>)

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">claim_set</span>.<span class="ruby-identifier">blank?</span>
    <span class="ruby-identifier">claim_set</span> = <span class="ruby-constant">ClaimSet</span>.<span class="ruby-identifier">create!</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">cs</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">cs</span>.<span class="ruby-identifier">code</span> = <span class="ruby-identifier">clearing_code</span>
      <span class="ruby-identifier">cs</span>.<span class="ruby-identifier">name</span> = <span class="ruby-node">&quot;#{entity_code} #{clearing_code}&quot;</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">claim</span> = <span class="ruby-constant">Claim</span>.<span class="ruby-identifier">find_by_code</span>(<span class="ruby-identifier">claim_code</span>)

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">claim</span>.<span class="ruby-identifier">blank?</span>
    <span class="ruby-comment"># puts &quot;building claim #{claim_code}&quot;</span>
    <span class="ruby-identifier">claim</span> = <span class="ruby-constant">Claim</span>.<span class="ruby-identifier">create!</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">c</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">c</span>.<span class="ruby-identifier">claim_set</span> = <span class="ruby-identifier">claim_set</span>
      <span class="ruby-identifier">c</span>.<span class="ruby-identifier">entity_id</span> = <span class="ruby-identifier">entity</span>.<span class="ruby-identifier">id</span>
      <span class="ruby-identifier">c</span>.<span class="ruby-identifier">code</span> = <span class="ruby-identifier">claim_code</span>
      <span class="ruby-identifier">c</span>.<span class="ruby-identifier">name</span> = <span class="ruby-node">&quot;#{entity_code} #{claim_code}&quot;</span>
      <span class="ruby-identifier">c</span>.<span class="ruby-identifier">size</span> = <span class="ruby-identifier">size</span>
      <span class="ruby-identifier">c</span>.<span class="ruby-identifier">claim_type</span> = <span class="ruby-identifier">claim_type</span>
      <span class="ruby-identifier">c</span>.<span class="ruby-identifier">claim_sub_type</span> = <span class="ruby-identifier">claim_sub_type</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">claim_sub_type</span>.<span class="ruby-identifier">blank?</span>
      <span class="ruby-identifier">c</span>.<span class="ruby-identifier">point_value</span> = <span class="ruby-identifier">point_value</span>
      <span class="ruby-identifier">c</span>.<span class="ruby-identifier">price_ccy</span> = <span class="ruby-identifier">doc</span>.<span class="ruby-identifier">css</span>(<span class="ruby-string">&#39;FIXML TrdCaptRpt Instrmt&#39;</span>).<span class="ruby-identifier">first</span>[<span class="ruby-string">&#39;PxQteCcy&#39;</span>]
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-comment"># puts &quot;found claim #{claim_code}&quot;</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-comment"># puts claim.valid?</span>
  <span class="ruby-comment"># puts claim.errors.keys</span>
  <span class="ruby-identifier">claim</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-c-build_from_fix_42" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">build_from_fix_42</span><span
            class="method-args">(params)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="build_from_fix_42-source">
            <pre><span class="ruby-comment"># File app/models/builders/claim_builder.rb, line 39</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">build_from_fix_42</span>(<span class="ruby-identifier">params</span>)
  <span class="ruby-identifier">claim_alias</span> = <span class="ruby-identifier">find_aacc_claim_alias</span>(<span class="ruby-identifier">params</span>)

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">claim_alias</span>.<span class="ruby-identifier">blank?</span>
    <span class="ruby-identifier">claim</span> = <span class="ruby-identifier">build_from_aacc_fix_42</span>(<span class="ruby-identifier">params</span>)
    <span class="ruby-constant">ClaimAliasBuilder</span>.<span class="ruby-identifier">build_for_acc</span>(<span class="ruby-identifier">params</span>)
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">claim</span> = <span class="ruby-identifier">claim_alias</span>.<span class="ruby-identifier">claim</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">claim</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-c-cme_fixml_claim_code_mapper" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">cme_fixml_claim_code_mapper</span><span
            class="method-args">(doc)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="cme_fixml_claim_code_mapper-source">
            <pre><span class="ruby-comment"># File app/models/builders/claim_builder.rb, line 680</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">cme_fixml_claim_code_mapper</span>(<span class="ruby-identifier">doc</span>)
  <span class="ruby-comment"># There is probably a better way to do this</span>
  <span class="ruby-comment"># using regex matching and substitution.</span>
  <span class="ruby-identifier">given_code</span> = <span class="ruby-identifier">doc</span>.<span class="ruby-identifier">css</span>(<span class="ruby-string">&#39;FIXML TrdCaptRpt Instrmt&#39;</span>).<span class="ruby-identifier">first</span>[<span class="ruby-string">&#39;Sym&#39;</span>] <span class="ruby-comment"># GEM4, ZCH4</span>
  <span class="ruby-identifier">clearing_code</span> = <span class="ruby-identifier">doc</span>.<span class="ruby-identifier">css</span>(<span class="ruby-string">&#39;FIXML TrdCaptRpt Instrmt&#39;</span>).<span class="ruby-identifier">first</span>[<span class="ruby-string">&#39;ID&#39;</span>] <span class="ruby-comment"># ED, C</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">given_code</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp">/-/</span>
    <span class="ruby-comment"># spread symbol</span>
    <span class="ruby-identifier">given_codes</span> = <span class="ruby-identifier">given_code</span>.<span class="ruby-identifier">split</span>(<span class="ruby-regexp">/-/</span>)
    <span class="ruby-identifier">built_codes</span> = []
    <span class="ruby-identifier">given_codes</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">gc</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">delivery_code</span> = <span class="ruby-identifier">gc</span>.<span class="ruby-identifier">split</span>(<span class="ruby-regexp">//</span>).<span class="ruby-identifier">last</span>(<span class="ruby-value">2</span>).<span class="ruby-identifier">join</span>
      <span class="ruby-identifier">built_codes</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">clearing_code</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">delivery_code</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-identifier">code</span> = <span class="ruby-identifier">built_codes</span>.<span class="ruby-identifier">join</span>(<span class="ruby-string">&#39;-&#39;</span>)
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">delivery_code</span> = <span class="ruby-identifier">given_code</span>.<span class="ruby-identifier">split</span>(<span class="ruby-regexp">//</span>).<span class="ruby-identifier">last</span>(<span class="ruby-value">2</span>).<span class="ruby-identifier">join</span>
    <span class="ruby-identifier">code</span> = <span class="ruby-identifier">clearing_code</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">delivery_code</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">code</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-c-cme_fixml_claim_code_mapper_eod" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">cme_fixml_claim_code_mapper_eod</span><span
            class="method-args">(params)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="cme_fixml_claim_code_mapper_eod-source">
            <pre><span class="ruby-comment"># File app/models/builders/claim_builder.rb, line 701</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">cme_fixml_claim_code_mapper_eod</span>(<span class="ruby-identifier">params</span>)
  <span class="ruby-identifier">claim_set_code</span> = <span class="ruby-identifier">params</span>[<span class="ruby-string">&#39;FIXML&#39;</span>][<span class="ruby-string">&#39;TrdCaptRpt&#39;</span>][<span class="ruby-string">&#39;Instrmt&#39;</span>][<span class="ruby-string">&#39;ID&#39;</span>]
  <span class="ruby-identifier">year</span> = <span class="ruby-identifier">params</span>[<span class="ruby-string">&#39;FIXML&#39;</span>][<span class="ruby-string">&#39;TrdCaptRpt&#39;</span>][<span class="ruby-string">&#39;Instrmt&#39;</span>][<span class="ruby-string">&#39;MMY&#39;</span>][<span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-value">3</span>]
  <span class="ruby-identifier">month</span> = <span class="ruby-identifier">params</span>[<span class="ruby-string">&#39;FIXML&#39;</span>][<span class="ruby-string">&#39;TrdCaptRpt&#39;</span>][<span class="ruby-string">&#39;Instrmt&#39;</span>][<span class="ruby-string">&#39;MMY&#39;</span>][<span class="ruby-value">4</span><span class="ruby-operator">..</span><span class="ruby-value">5</span>]
  <span class="ruby-identifier">delivery_code</span> = <span class="ruby-constant">N2L</span>[<span class="ruby-identifier">month</span>] <span class="ruby-operator">+</span> <span class="ruby-identifier">year</span>[<span class="ruby-value">2</span><span class="ruby-operator">..</span><span class="ruby-value">3</span>]
  <span class="ruby-identifier">claim_set_code</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">delivery_code</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-c-find_aacc_claim_alias" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">find_aacc_claim_alias</span><span
            class="method-args">(params)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="find_aacc_claim_alias-source">
            <pre><span class="ruby-comment"># File app/models/builders/claim_builder.rb, line 52</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">find_aacc_claim_alias</span>(<span class="ruby-identifier">params</span>)
  <span class="ruby-identifier">system</span> = <span class="ruby-constant">System</span>.<span class="ruby-identifier">find_by_code</span>(<span class="ruby-string">&#39;AACC&#39;</span>)
  <span class="ruby-identifier">code</span> = <span class="ruby-node">&quot;#{params[&#39;207&#39;]}:#{params[&#39;55&#39;]}:#{params[&#39;200&#39;]}&quot;</span>
  <span class="ruby-constant">ClaimAlias</span>.<span class="ruby-identifier">find_by_system_id_and_code</span>(<span class="ruby-identifier">system</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">code</span>)
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-c-get_claim_set_aacc_eod_csv" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">get_claim_set_aacc_eod_csv</span><span
            class="method-args">(params)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="get_claim_set_aacc_eod_csv-source">
            <pre><span class="ruby-comment"># File app/models/builders/claim_builder.rb, line 349</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">get_claim_set_aacc_eod_csv</span>(<span class="ruby-identifier">params</span>)
  <span class="ruby-identifier">system</span> = <span class="ruby-identifier">params</span>[<span class="ruby-value">:system</span>]
  <span class="ruby-identifier">dealing_venue</span> = <span class="ruby-identifier">params</span>[<span class="ruby-value">:dealing_venue</span>]

  <span class="ruby-identifier">claim_set_code_alias</span> = <span class="ruby-node">&quot;#{params[:ary][79]}:#{params[:ary][80]}&quot;</span>
  <span class="ruby-identifier">claim_set_alias</span> = <span class="ruby-constant">ClaimSetAlias</span>.<span class="ruby-identifier">where</span>(<span class="ruby-identifier">system_id</span><span class="ruby-operator">:</span> <span class="ruby-identifier">system</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">code</span><span class="ruby-operator">:</span> <span class="ruby-identifier">claim_set_code_alias</span>).<span class="ruby-identifier">first</span>

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">claim_set_alias</span>.<span class="ruby-identifier">blank?</span>
    <span class="ruby-comment"># If we don&#39;t have a claim_set_alias</span>
    <span class="ruby-comment"># assume we don&#39;t have a claim_set.</span>
    <span class="ruby-comment"># This is the hack for the - for now.</span>

    <span class="ruby-identifier">set_code</span> = <span class="ruby-identifier">params</span>[<span class="ruby-value">:ary</span>][<span class="ruby-value">80</span>]

    <span class="ruby-identifier">claim_set_code</span> = <span class="ruby-node">&quot;#{dealing_venue.code}:#{set_code}&quot;</span>

    <span class="ruby-identifier">claim_set</span> = <span class="ruby-constant">ClaimSet</span>.<span class="ruby-identifier">find_by_code</span>(<span class="ruby-identifier">claim_set_code</span>)

    <span class="ruby-keyword">if</span> <span class="ruby-identifier">claim_set</span>.<span class="ruby-identifier">blank?</span>
      <span class="ruby-identifier">claim_set</span> = <span class="ruby-constant">ClaimSet</span>.<span class="ruby-identifier">create!</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">s</span><span class="ruby-operator">|</span>
        <span class="ruby-identifier">s</span>.<span class="ruby-identifier">code</span> = <span class="ruby-node">&quot;#{claim_set_code}&quot;</span>
        <span class="ruby-identifier">s</span>.<span class="ruby-identifier">name</span> = <span class="ruby-node">&quot;#{claim_set_code} [fixme]&quot;</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-identifier">claim_set_alias</span> = <span class="ruby-constant">ClaimSetAlias</span>.<span class="ruby-identifier">create!</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">a</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">a</span>.<span class="ruby-identifier">claim_set_id</span> = <span class="ruby-identifier">claim_set</span>.<span class="ruby-identifier">id</span>
      <span class="ruby-identifier">a</span>.<span class="ruby-identifier">system_id</span> = <span class="ruby-identifier">system</span>.<span class="ruby-identifier">id</span>
      <span class="ruby-identifier">a</span>.<span class="ruby-identifier">code</span> = <span class="ruby-identifier">claim_set_code_alias</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-identifier">claim_set_alias</span>.<span class="ruby-identifier">claim_set</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-comment"># If we have a claim_set_alias</span>
    <span class="ruby-comment"># we must have a claim_set too.</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">claim_set_alias</span>.<span class="ruby-identifier">claim_set</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-c-get_claim_set_abn_pos_csv" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">get_claim_set_abn_pos_csv</span><span
            class="method-args">(params)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="get_claim_set_abn_pos_csv-source">
            <pre><span class="ruby-comment"># File app/models/builders/claim_builder.rb, line 389</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">get_claim_set_abn_pos_csv</span>(<span class="ruby-identifier">params</span>)
  <span class="ruby-identifier">system</span> = <span class="ruby-identifier">params</span>[<span class="ruby-value">:system</span>]
  <span class="ruby-identifier">dealing_venue</span> = <span class="ruby-identifier">params</span>[<span class="ruby-value">:dealing_venue</span>]

  <span class="ruby-identifier">ary</span> = <span class="ruby-identifier">params</span>[<span class="ruby-value">:ary</span>]

  <span class="ruby-identifier">claim_set_code_alias</span> = <span class="ruby-node">&quot;#{ary[11]}:#{ary[12]}&quot;</span>
  <span class="ruby-identifier">claim_set_alias</span> = <span class="ruby-constant">ClaimSetAlias</span>.<span class="ruby-identifier">where</span>(<span class="ruby-identifier">system_id</span><span class="ruby-operator">:</span> <span class="ruby-identifier">system</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">code</span><span class="ruby-operator">:</span> <span class="ruby-identifier">claim_set_code_alias</span>).<span class="ruby-identifier">first</span>

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">claim_set_alias</span>.<span class="ruby-identifier">blank?</span>
    <span class="ruby-comment"># If we don&#39;t have a claim_set_alias</span>
    <span class="ruby-comment"># assume we don&#39;t have a claim_set.</span>
    <span class="ruby-comment"># This is the hack for the - for now.</span>

    <span class="ruby-identifier">set_code</span> = <span class="ruby-identifier">ary</span>[<span class="ruby-value">12</span>]

    <span class="ruby-identifier">claim_set_code</span> = <span class="ruby-node">&quot;#{dealing_venue.code}:#{set_code}&quot;</span>

    <span class="ruby-identifier">claim_set</span> = <span class="ruby-constant">ClaimSet</span>.<span class="ruby-identifier">find_by_code</span>(<span class="ruby-identifier">claim_set_code</span>)

    <span class="ruby-keyword">if</span> <span class="ruby-identifier">claim_set</span>.<span class="ruby-identifier">blank?</span>
      <span class="ruby-identifier">claim_set</span> = <span class="ruby-constant">ClaimSet</span>.<span class="ruby-identifier">create!</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">s</span><span class="ruby-operator">|</span>
        <span class="ruby-identifier">s</span>.<span class="ruby-identifier">code</span> = <span class="ruby-node">&quot;#{claim_set_code}&quot;</span>
        <span class="ruby-identifier">s</span>.<span class="ruby-identifier">name</span> = <span class="ruby-node">&quot;#{claim_set_code} [fixme]&quot;</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-identifier">claim_set_alias</span> = <span class="ruby-constant">ClaimSetAlias</span>.<span class="ruby-identifier">create!</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">a</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">a</span>.<span class="ruby-identifier">claim_set_id</span> = <span class="ruby-identifier">claim_set</span>.<span class="ruby-identifier">id</span>
      <span class="ruby-identifier">a</span>.<span class="ruby-identifier">system_id</span> = <span class="ruby-identifier">system</span>.<span class="ruby-identifier">id</span>
      <span class="ruby-identifier">a</span>.<span class="ruby-identifier">code</span> = <span class="ruby-identifier">claim_set_code_alias</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-identifier">claim_set_alias</span>.<span class="ruby-identifier">claim_set</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-comment"># If we have a claim_set_alias</span>
    <span class="ruby-comment"># we must have a claim_set too.</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">claim_set_alias</span>.<span class="ruby-identifier">claim_set</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-c-get_claim_set_fixml" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">get_claim_set_fixml</span><span
            class="method-args">(doc)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="get_claim_set_fixml-source">
            <pre><span class="ruby-comment"># File app/models/builders/claim_builder.rb, line 321</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">get_claim_set_fixml</span>(<span class="ruby-identifier">doc</span>)
  <span class="ruby-identifier">exchange_code</span> = <span class="ruby-identifier">doc</span>.<span class="ruby-identifier">css</span>(<span class="ruby-string">&#39;FIXML TrdCaptRpt Hdr&#39;</span>)[<span class="ruby-value">0</span>][<span class="ruby-string">&#39;SID&#39;</span>]
  <span class="ruby-identifier">set_code</span> = <span class="ruby-identifier">doc</span>.<span class="ruby-identifier">css</span>(<span class="ruby-string">&#39;FIXML TrdCaptRpt Instrmt&#39;</span>)[<span class="ruby-value">0</span>][<span class="ruby-string">&#39;ID&#39;</span>]
  <span class="ruby-identifier">code</span> = <span class="ruby-node">&quot;#{exchange_code}:#{set_code}&quot;</span>
  <span class="ruby-identifier">claim_set</span> = <span class="ruby-constant">ClaimSet</span>.<span class="ruby-identifier">find_by_code</span>(<span class="ruby-identifier">code</span>)

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">claim_set</span>.<span class="ruby-identifier">blank?</span>
    <span class="ruby-identifier">claim_set</span> = <span class="ruby-constant">ClaimSet</span>.<span class="ruby-identifier">create!</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">s</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">s</span>.<span class="ruby-identifier">code</span> = <span class="ruby-identifier">code</span>
      <span class="ruby-identifier">s</span>.<span class="ruby-identifier">name</span> = <span class="ruby-identifier">code</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-identifier">system</span> = <span class="ruby-constant">System</span>.<span class="ruby-identifier">find_by_code</span>(<span class="ruby-string">&#39;AACC&#39;</span>)

    <span class="ruby-identifier">claim_set_alias</span> = <span class="ruby-constant">ClaimSetAlias</span>.<span class="ruby-identifier">find_by_system_id_and_code</span>(<span class="ruby-identifier">system</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">code</span>)

    <span class="ruby-keyword">if</span> <span class="ruby-identifier">claim_set_alias</span>.<span class="ruby-identifier">blank?</span>
      <span class="ruby-constant">ClaimSetAlias</span>.<span class="ruby-identifier">create!</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">a</span><span class="ruby-operator">|</span>
        <span class="ruby-identifier">a</span>.<span class="ruby-identifier">claim_set_id</span> = <span class="ruby-identifier">claim_set</span>.<span class="ruby-identifier">id</span>
        <span class="ruby-identifier">a</span>.<span class="ruby-identifier">system_id</span> = <span class="ruby-identifier">system</span>.<span class="ruby-identifier">id</span>
        <span class="ruby-identifier">a</span>.<span class="ruby-identifier">code</span> = <span class="ruby-identifier">code</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">claim_set</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-c-get_claim_set_from_aacc_fix_42" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">get_claim_set_from_aacc_fix_42</span><span
            class="method-args">(params)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="get_claim_set_from_aacc_fix_42-source">
            <pre><span class="ruby-comment"># File app/models/builders/claim_builder.rb, line 431</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">get_claim_set_from_aacc_fix_42</span>(<span class="ruby-identifier">params</span>)
  <span class="ruby-comment">#</span>
  <span class="ruby-comment"># All a bit of a hack.</span>
  <span class="ruby-comment"># claim_set ~ claim_set_alias</span>
  <span class="ruby-comment">#</span>

  <span class="ruby-identifier">system</span> = <span class="ruby-identifier">params</span>[<span class="ruby-value">:system</span>]
  <span class="ruby-identifier">dealing_venue</span> = <span class="ruby-identifier">params</span>[<span class="ruby-value">:dealing_venue</span>]

  <span class="ruby-identifier">claim_set_code_alias</span> = <span class="ruby-node">&quot;#{params[&#39;207&#39;]}:#{params[&#39;55&#39;]}&quot;</span>
  <span class="ruby-identifier">claim_set_alias</span> = <span class="ruby-constant">ClaimSetAlias</span>.<span class="ruby-identifier">where</span>(<span class="ruby-identifier">system_id</span><span class="ruby-operator">:</span> <span class="ruby-identifier">system</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">code</span><span class="ruby-operator">:</span> <span class="ruby-identifier">claim_set_code_alias</span>).<span class="ruby-identifier">first</span>

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">claim_set_alias</span>.<span class="ruby-identifier">blank?</span>
    <span class="ruby-comment"># If we don&#39;t have a claim_set_alias</span>
    <span class="ruby-comment"># assume we don&#39;t have a claim_set.</span>
    <span class="ruby-comment"># This is the hack for the - for now.</span>

    <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-string">&#39;9039&#39;</span>] <span class="ruby-operator">=~</span> <span class="ruby-regexp">/^TRC/</span>
      <span class="ruby-identifier">set_code</span> = <span class="ruby-identifier">params</span>[<span class="ruby-string">&#39;9039&#39;</span>].<span class="ruby-identifier">slice</span>(<span class="ruby-value">83</span>, <span class="ruby-value">4</span>).<span class="ruby-identifier">strip</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">set_code</span> = <span class="ruby-identifier">params</span>[<span class="ruby-string">&#39;55&#39;</span>]
    <span class="ruby-keyword">end</span>

    <span class="ruby-identifier">claim_set</span> = <span class="ruby-constant">ClaimSet</span>.<span class="ruby-identifier">create!</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">s</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">s</span>.<span class="ruby-identifier">code</span> = <span class="ruby-node">&quot;#{dealing_venue.code}:#{set_code}&quot;</span>
      <span class="ruby-identifier">s</span>.<span class="ruby-identifier">name</span> = <span class="ruby-node">&quot;#{dealing_venue.code}:#{set_code} [fixme]&quot;</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-identifier">claim_set_alias</span> = <span class="ruby-constant">ClaimSetAlias</span>.<span class="ruby-identifier">create!</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">a</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">a</span>.<span class="ruby-identifier">claim_set_id</span> = <span class="ruby-identifier">claim_set</span>.<span class="ruby-identifier">id</span>
      <span class="ruby-identifier">a</span>.<span class="ruby-identifier">system_id</span> = <span class="ruby-identifier">system</span>.<span class="ruby-identifier">id</span>
      <span class="ruby-identifier">a</span>.<span class="ruby-identifier">code</span> = <span class="ruby-identifier">claim_set_code_alias</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-identifier">claim_set_alias</span>.<span class="ruby-identifier">claim_set</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-comment"># If we have a claim_set_alias</span>
    <span class="ruby-comment"># we must have a claim_set too.</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">claim_set_alias</span>.<span class="ruby-identifier">claim_set</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
    </section>
  
  </section>
</main>


<footer id="validator-badges" role="contentinfo">
  <p><a href="http://validator.w3.org/check/referer">Validate</a>
  <p>Generated by <a href="http://docs.seattlerb.org/rdoc/">RDoc</a> 4.2.2.
  <p>Based on <a href="http://deveiate.org/projects/Darkfish-RDoc/">Darkfish</a> by <a href="http://deveiate.org">Michael Granger</a>.
</footer>

